<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Karyawan (Supabase + Google Drive Backup)</title>

  <!-- Fonts + Icons + Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Google API client -->
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    :root{--primary:#4CAF50;--secondary:#2196F3;--danger:#f44336;--light:#f4f4f4;--white:#fff}
    *{box-sizing:border-box}
    body{font-family:Roboto,Arial,sans-serif;background:var(--light);color:#222;margin:0;padding:18px}
    .login-form,.card{background:var(--white);padding:16px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.06);margin-bottom:18px}
    .login-form{max-width:560px;margin:48px auto;text-align:center}
    input,select,button{font-size:14px}
    input,select{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:6px}
    button{padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-secondary{background:var(--secondary);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    header.app-header{background:var(--primary);color:#fff;padding:12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e6e6e6;padding:8px;text-align:center}
    th{background:var(--primary);color:#fff}
    .action-buttons{display:flex;gap:8px;justify-content:center}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.grid-2{grid-template-columns:1fr}}
    .small{font-size:0.9rem;color:#666}
    .file-name{font-size:0.9rem;color:#444;margin-top:6px}
    img.profile-thumb{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid #ddd}
    .flex-right{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginScreen" class="login-form">
    <h2><i class="fas fa-user-lock"></i> Login Sistem</h2>
    <p class="small">Pilih peran: User/Operator (input saja) atau Admin (edit & hapus)</p>
    <select id="role">
      <option value="user">User / Operator</option>
      <option value="admin">Admin</option>
    </select>
    <input id="username" type="text" placeholder="Username (admin/user)">
    <input id="password" type="password" placeholder="Password">
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="loginBtn" class="btn-primary">Masuk</button>
    </div>
    <p class="small" style="margin-top:12px;color:#555">
      Default admin: <strong>admin/admin123</strong> â€” user: <strong>user/user123</strong>.
    </p>
  </div>

  <!-- APP -->
  <div id="mainApp" style="display:none;">
    <header class="app-header">
      <div><h3 style="margin:0"><i class="fas fa-building"></i> Dashboard Karyawan</h3></div>
      <div style="display:flex;align-items:center;gap:12px">
        <div id="roleLabel" class="small"></div>
        <button id="logoutBtn" class="btn-danger">Keluar</button>
      </div>
    </header>

    <!-- Form -->
    <div class="card">
      <h4 id="formTitle">Tambah Karyawan</h4>
      <input type="hidden" id="editId" value="">
      <div class="grid-2">
        <input id="nama" type="text" placeholder="Nama Lengkap">
        <input id="nik" type="text" placeholder="NIK (16 digit)" maxlength="16">
        <select id="alamat">
          <option value="">Pilih Wilayah</option>
          <option value="Bandar Lampung">Bandar Lampung</option>
          <option value="Metro">Metro</option>
          <option value="Lampung Selatan">Lampung Selatan</option>
          <option value="Lampung Tengah">Lampung Tengah</option>
          <option value="Lampung Utara">Lampung Utara</option>
          <option value="Way Kanan">Way Kanan</option>
          <option value="Tulang Bawang">Tulang Bawang</option>
          <option value="Tulang Bawang Barat">Tulang Bawang Barat</option>
          <option value="Mesuji">Mesuji</option>
          <option value="Pesawaran">Pesawaran</option>
          <option value="Pringsewu">Pringsewu</option>
          <option value="Tanggamus">Tanggamus</option>
          <option value="Pesisir Barat">Pesisir Barat</option>
          <option value="Lampung Barat">Lampung Barat</option>
          <option value="Lampung Timur">Lampung Timur</option>
        </select>
        <input id="telepon" type="text" placeholder="Nomor Telepon (maks 13 digit)" maxlength="13">
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <input id="mulai" type="date">
        <select id="pendidikan">
          <option value="">Pilih Pendidikan</option>
          <option value="SMA/SMK/MA">SMA/SMK/MA</option>
          <option value="Sarjana">Sarjana</option>
          <option value="Magister">Magister</option>
          <option value="Doktor">Doktor</option>
          <option value="Profesor">Profesor</option>
        </select>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <select id="jabatan">
          <option value="">Pilih Jabatan</option>
          <option value="Direktur">Direktur</option>
          <option value="Manajer">Manajer</option>
          <option value="Teller">Teller</option>
          <option value="Accounting">Accounting</option>
          <option value="Account Officer">Account Officer</option>
          <option value="Customer Service">Customer Service</option>
          <option value="Marketing">Marketing</option>
        </select>
        <select id="status">
          <option value="">Pilih Status</option>
          <option value="Aktif">Aktif</option>
          <option value="Non Aktif">Non Aktif</option>
          <option value="Nonjob">Nonjob</option>
          <option value="Resign">Resign</option>
          <option value="Lainnya">Lainnya</option>
        </select>
      </div>

      <div style="margin-top:8px;" class="grid-2">
        <div>
          <label for="fileUpload">Upload File (kontrak/dokumen - pdf/doc/img):</label>
          <input id="fileUpload" type="file" accept=".pdf,.doc,.docx,image/*">
          <div id="fileHint" class="file-name"></div>
        </div>
        <div>
          <label for="fotoUpload">Foto Profil:</label>
          <input id="fotoUpload" type="file" accept="image/*">
          <div id="fotoHint" class="file-name"></div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px;">
        <button id="clearBtn" class="btn-secondary">Clear</button>
        <button id="saveBtn" class="btn-primary">Simpan</button>
      </div>
    </div>

    <!-- Table + actions -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <input id="searchInput" type="text" placeholder="Cari karyawan...">
        <div class="flex-right">
          <button id="sampleBtn" class="btn-secondary" title="Isi data contoh">Isi Contoh</button>
          <button id="printBtn" class="btn-secondary">Cetak PDF</button>
          <button id="exportBtn" class="btn-primary">Export Excel</button>
          <button id="backupDriveBtn" class="btn-secondary">Backup ke Google Drive</button>
        </div>
      </div>

      <table id="karyawanTable">
        <thead>
          <tr>
            <th>Foto</th><th>Nama</th><th>NIK</th><th>Alamat</th><th>Telepon</th><th>Pendidikan</th><th>Jabatan</th><th>Status</th><th>File</th><th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Chart -->
    <div class="card">
      <h4>Statistik Karyawan per Wilayah</h4>
      <canvas id="statsChart" height="100"></canvas>
    </div>
  </div>

  <script>
    // =================== KONFIGURASI (GANTI DENGAN KREDENSIAL ANDA) ===================
    // Login default (demo)
    const ADMIN_USER = 'admin', ADMIN_PASS = 'admin123';
    const USER_USER = 'user', USER_PASS = 'user123';

    // SUPABASE - ganti sesuai proyek Anda
    const SUPABASE_URL = 'https://cptwgqmohesenhqwewoz.supabase.co'; // contoh: https://abcd1234.supabase.co
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwdHdncW1vaGVzZW5ocXdld296Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzI2NDQsImV4cCI6MjA3MzY0ODY0NH0.RCmHjaohWUlgtHg1TLId0F9C7wljQQJEV4eOE8DWRCQ';
    const SUPABASE_TABLE = 'karyawan';
    const SUPABASE_BUCKET = 'profiles';
    
    // Header untuk operasi CRUD (JSON: insert/update/select tabel)
  const SUPABASE_HEADERS = {
    'apikey': SUPABASE_KEY,
    'Authorization': `Bearer ${SUPABASE_KEY}`,
    'Content-Type': 'application/json'
  };

  // Header untuk upload file (foto/dokumen)
  function getFileHeaders(fileType) {
    return {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': fileType || 'application/octet-stream'
    };
  }

  // === Contoh fungsi upload foto ke Storage ===
  async function uploadFotoToStorage(file, nik) {
    if (!file) return '';
    try {
      // nama file unik: nik_timestamp_namafile
      const filePath = `${encodeURIComponent(nik)}_${Date.now()}_${encodeURIComponent(file.name)}`;
      const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${SUPABASE_BUCKET}/${filePath}`;

      const res = await fetch(uploadUrl, {
        method: "PUT",
        headers: getFileHeaders(file.type),
        body: file
      });

      if (!res.ok) {
        console.error("Upload foto gagal:", await res.text());
        return '';
      }

      // URL publik foto
      return `${SUPABASE_URL}/storage/v1/object/public/${SUPABASE_BUCKET}/${filePath}`;
    } catch (e) {
      console.error("uploadFotoToStorage error", e);
      return '';
    }
  };

    // GOOGLE DRIVE - ganti dengan kredensial Anda (OAuth client ID & API key)
    const CLIENT_ID = "https://script.google.com/macros/s/AKfycbxBddB4Qb9MUKY_qF3M10DXK0o96Won_-0tD8FvbZGt_xZ4b1PyfzVPZlaoQU49BQYenQ/exec";
    const API_KEY = "AKfycbxBddB4Qb9MUKY_qF3M10DXK0o96Won_-0tD8FvbZGt_xZ4b1PyfzVPZlaoQU49BQYenQ";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    // =================== STATE ===================
    let currentRole = '';
    let allData = [];
    let chart = null;

    // =================== HELPERS ===================
    function escapeHtml(s){ if (s===undefined||s===null) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function readFileAsDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = e => reject(e);
        r.readAsDataURL(file);
      });
    }

    // =================== LOGIN / LOGOUT ===================
    function login(){
      const role = (document.getElementById('role')||{}).value;
      const u = (document.getElementById('username')||{}).value||'';
      const p = (document.getElementById('password')||{}).value||'';
      if(role==='admin' && u===ADMIN_USER && p===ADMIN_PASS) currentRole='admin';
      else if(role==='user' && u===USER_USER && p===USER_PASS) currentRole='user';
      else { alert('Login gagal!'); return; }

      document.getElementById('loginScreen').style.display='none';
      document.getElementById('mainApp').style.display='block';
      document.getElementById('roleLabel').textContent = 'Peran: ' + currentRole.toUpperCase();

      // restore from cloud (optional) then load local
      restoreFromSupabase().then(()=>{ loadLocalData(); renderAll(); });
    }

    function logout(){ location.reload(); }

    // =================== LOCAL STORAGE ===================
    function loadLocalData(){ try{ allData = JSON.parse(localStorage.getItem('karyawanData'))||[]; }catch(e){ allData=[]; } }
    function saveLocalData(){ localStorage.setItem('karyawanData', JSON.stringify(allData)); }

    // =================== SUPABASE BACKUP / RESTORE ===================
    async function backupKeSupabase(data){
      if(!SUPABASE_URL||!SUPABASE_KEY||SUPABASE_KEY==='your-anon-public-key') {
        console.warn('Supabase belum dikonfigurasi. Ganti SUPABASE_URL & SUPABASE_KEY.');
        return;
      }
      if(!navigator.onLine) { console.warn('Offline - skip backup'); return; }
      try{
        if(data && data.length){
          // server side shape (hindari mengirim terlalu banyak base64 jika tidak perlu)
          const body = JSON.stringify(data.map(d=>({
            nik: d.nik||'',
            nama: d.nama||'',
            alamat: d.alamat||'',
            telepon: d.telepon||'',
            mulai: d.mulai||'',
            pendidikan: d.pendidikan||'',
            jabatan: d.jabatan||'',
            status: d.status||'',
            fileName: d.fileName||'',
            fileData: d.fileData||'',
            fotoUrl: d.fotoUrl||''
          })));
          // upsert via REST (on_conflict=nik). Pastikan kolom nik UNIQUE di DB Supabase.
          const url = `${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}?on_conflict=nik`;
          const res = await fetch(url, {
            method:'POST',
            headers:{...SUPABASE_HEADERS, 'Prefer':'resolution=merge-duplicates'},
            body
          });
          if(!res.ok){
            console.warn('Backup response tidak OK', res.status, await res.text());
          } else {
            console.log('Backup sukses ke Supabase');
          }
        }
      }catch(err){ console.error('Backup error', err); }
    }

    async function restoreFromSupabase(){
      if(!SUPABASE_URL||!SUPABASE_KEY||SUPABASE_KEY==='your-anon-public-key') {
        console.warn('Supabase belum dikonfigurasi. Ganti SUPABASE_URL & SUPABASE_KEY.');
        return;
      }
      if(!navigator.onLine) { console.warn('Offline - skip restore'); return; }
      try{
        const res = await fetch(`${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}?select=*`, { headers: SUPABASE_HEADERS });
        if(!res.ok){ console.error('Restore fetch error', res.status, await res.text()); return; }
        const data = await res.json();
        console.log('Data cloud:', data);
        if(Array.isArray(data) && data.length){
          if(confirm('Data cloud ditemukan. Ganti data lokal dengan data dari Supabase?')){
            allData = data.map(d => ({
              nama: d.nama||'',
              nik: d.nik||'',
              alamat: d.alamat||'',
              telepon: d.telepon||'',
              mulai: d.mulai||'',
              pendidikan: d.pendidikan||'',
              jabatan: d.jabatan||'',
              status: d.status||'',
              fileName: d.fileName||'',
              fileData: d.fileData||'',
              fotoUrl: d.fotoUrl||''
            }));
            saveLocalData();
            alert('Restore selesai: data cloud telah menggantikan data lokal.');
          }
        }
      }catch(err){ console.error('Restore error', err); }
    }

    // =================== SUPABASE STORAGE (UPLOAD FOTO) ===================
    async function uploadFotoToStorage(file, nik){
      if(!file) return '';
      if(!SUPABASE_URL||!SUPABASE_KEY||SUPABASE_KEY==='your-anon-public-key'){ console.warn('Supabase storage not configured'); return ''; }
      try{
        // safe filename
        const filePath = `${encodeURIComponent(nik)}_${Date.now()}_${encodeURIComponent(file.name)}`;
        const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${SUPABASE_BUCKET}/${filePath}`;
        // Use PUT to upload raw binary to Supabase storage endpoint
        const res = await fetch(uploadUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'apikey': SUPABASE_KEY,
            'Content-Type': file.type || 'application/octet-stream',
            'x-upsert': 'false'
          },
          body: file
        });
        if(!res.ok){
          console.error('Upload foto gagal', res.status, await res.text());
          return '';
        }
        const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${SUPABASE_BUCKET}/${filePath}`;
        return publicUrl;
      }catch(e){
        console.error('uploadFotoToStorage error', e);
        return '';
      }
    }

    // =================== CRUD ===================
    async function simpanKaryawan(){
      const nama = (document.getElementById('nama')||{}).value||'';
      const nik = (document.getElementById('nik')||{}).value||'';
      const alamat = (document.getElementById('alamat')||{}).value||'';
      const telepon = (document.getElementById('telepon')||{}).value||'';
      const mulai = (document.getElementById('mulai')||{}).value||'';
      const pendidikan = (document.getElementById('pendidikan')||{}).value||'';
      const jabatan = (document.getElementById('jabatan')||{}).value||'';
      const status = (document.getElementById('status')||{}).value||'';
      const fileInput = document.getElementById('fileUpload');
      const fotoInput = document.getElementById('fotoUpload');
      const editId = (document.getElementById('editId')||{}).value||'';

      if(!nama || !nik){ alert('Nama dan NIK wajib diisi'); return; }
      if(!/^[0-9]{16}$/.test(nik)){ alert('NIK harus 16 digit angka'); return; }
      if(telepon && (!/^[0-9]+$/.test(telepon) || telepon.length > 13)){ alert('Nomor telepon maksimal 13 digit angka'); return; }

      let fileName = '', fileData = '', fotoUrl = '';

      try{
        // If document selected -> read base64
        if(fileInput && fileInput.files && fileInput.files[0]){
          const f = fileInput.files[0];
          fileName = f.name;
          fileData = await readFileAsDataURL(f);
          document.getElementById('fileHint').textContent = `File terpasang: ${fileName}`;
        }

        // If foto selected -> upload to Supabase Storage
        if(fotoInput && fotoInput.files && fotoInput.files[0]){
          document.getElementById('fotoHint').textContent = 'Mengupload foto...';
          fotoUrl = await uploadFotoToStorage(fotoInput.files[0], nik);
          document.getElementById('fotoHint').textContent = fotoUrl ? 'Foto terupload' : 'Upload foto gagal';
        }

        const item = { nama, nik, alamat, telepon, mulai, pendidikan, jabatan, status, fileName, fotoUrl };

        upsertItem(editId, item);
      }catch(err){
        console.error('simpanKaryawan error', err);
        alert('Terjadi kesalahan saat menyimpan.');
      }
    }

    function upsertItem(editId, item){
      if(editId !== ''){
        const idx = parseInt(editId,10);
        if(!isNaN(idx) && idx>=0 && idx<allData.length){ allData[idx] = item; }
      } else {
        const found = allData.findIndex(x => (x.nik||'') === (item.nik||''));
        if(found >= 0) allData[found] = item;
        else allData.push(item);
      }
      saveLocalData();
      backupKeSupabase(allData); // push to Supabase as backup
      renderAll();
      clearForm();
    }

    function renderAll(){ renderRows(allData); renderChart(); }

    function renderRows(list){
      const tbody = document.querySelector('#karyawanTable tbody'); tbody.innerHTML = '';
      list.forEach((it, idx) => {
        const tr = document.createElement('tr');

        const fotoTd = document.createElement('td');
        if(it.fotoUrl){
          const img = document.createElement('img'); img.src = it.fotoUrl; img.className = 'profile-thumb';
          fotoTd.appendChild(img);
        } else {
          fotoTd.textContent = '-';
        }
        tr.appendChild(fotoTd);

        tr.appendChild(cell(it.nama||'-'));
        tr.appendChild(cell(it.nik||'-'));
        tr.appendChild(cell(it.alamat||'-'));
        tr.appendChild(cell(it.telepon||'-'));
        tr.appendChild(cell(it.pendidikan||'-'));
        tr.appendChild(cell(it.jabatan||'-'));
        tr.appendChild(cell(it.status||'-'));

        const fileTd = document.createElement('td');
        if(it.fileName && it.fileData){
          const a = document.createElement('a'); a.href = it.fileData; a.download = it.fileName; a.textContent = 'Download'; a.style.textDecoration = 'none';
          fileTd.appendChild(a);
        } else fileTd.textContent = '-';
        tr.appendChild(fileTd);

        const actionTd = document.createElement('td');
        if(currentRole === 'admin'){
          const wrap = document.createElement('div'); wrap.className = 'action-buttons';
          const editBtn = document.createElement('button'); editBtn.className = 'btn-secondary'; editBtn.textContent = 'Edit'; editBtn.onclick = () => editKaryawan(idx);
          const delBtn = document.createElement('button'); delBtn.className = 'btn-danger'; delBtn.textContent = 'Hapus';
          delBtn.onclick = () => { if(confirm('Hapus karyawan ini?')){ allData.splice(idx, 1); saveLocalData(); backupKeSupabase(allData); renderAll(); } };
          wrap.appendChild(editBtn); wrap.appendChild(delBtn); actionTd.appendChild(wrap);
        } else { actionTd.textContent = '-'; }
        tr.appendChild(actionTd);

        tbody.appendChild(tr);
      });
    }

    function cell(txt){ const td = document.createElement('td'); td.textContent = txt; return td; }

    function editKaryawan(i){
      if(typeof i !== 'number' || i<0 || i>=allData.length) return;
      const r = allData[i] || {};
      document.getElementById('editId').value = i.toString();
      document.getElementById('nama').value = r.nama || '';
      document.getElementById('nik').value = r.nik || '';
      document.getElementById('alamat').value = r.alamat || '';
      document.getElementById('telepon').value = r.telepon || '';
      document.getElementById('mulai').value = r.mulai || '';
      document.getElementById('pendidikan').value = r.pendidikan || '';
      document.getElementById('jabatan').value = r.jabatan || '';
      document.getElementById('status').value = r.status || '';
      document.getElementById('fileHint').textContent = r.fileName ? `File terpasang: ${r.fileName}` : 'Tidak ada file terpasang';
      document.getElementById('fotoHint').textContent = r.fotoUrl ? `Foto: terpasang` : '';
      document.getElementById('formTitle').textContent = 'Edit Karyawan';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function clearForm(){
      document.getElementById('editId').value = '';
      ['nama','nik','alamat','telepon','mulai','pendidikan','jabatan','status'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      const f = document.getElementById('fileUpload'); if(f) f.value = '';
      const p = document.getElementById('fotoUpload'); if(p) p.value = '';
      document.getElementById('fileHint').textContent = '';
      document.getElementById('fotoHint').textContent = '';
      document.getElementById('formTitle').textContent = 'Tambah Karyawan';
    }

    // =================== SEARCH & CHART ===================
    function searchKaryawan(){
      const q = (document.getElementById('searchInput')||{}).value||'';
      const term = q.trim().toLowerCase();
      if(!term){ renderRows(allData); renderChart(); return; }
      const filtered = allData.filter(r=> (r.nama||'').toLowerCase().includes(term) || (r.nik||'').includes(term) || (r.alamat||'').toLowerCase().includes(term) || (r.telepon||'').includes(term) || (r.jabatan||'').toLowerCase().includes(term));
      renderRows(filtered); renderChart(filtered);
    }

    function renderChart(sourceList){
      const list = Array.isArray(sourceList) ? sourceList : allData;
      const counts = {};
      list.forEach(it => { const k = it.alamat || 'Tidak Ada'; counts[k] = (counts[k]||0)+1; });
      const labels = Object.keys(counts).length ? Object.keys(counts) : ['Tidak Ada'];
      const values = Object.keys(counts).length ? Object.values(counts) : [0];
      const ctx = document.getElementById('statsChart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Jumlah Karyawan', data: values }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 } } } }
      });
    }

    // =================== PRINT & EXPORT ===================
    function cetakData(){
      const data = allData || [];
      let rows = '';
      data.forEach(it => {
        rows += '<tr>' + '<td>' + escapeHtml(it.nama||'-') + '</td>' + '<td>' + escapeHtml(it.nik||'-') + '</td>' + '<td>' + escapeHtml(it.alamat||'-') + '</td>' + '<td>' + escapeHtml(it.telepon||'-') + '</td>' + '<td>' + escapeHtml(it.pendidikan||'-') + '</td>' + '<td>' + escapeHtml(it.jabatan||'-') + '</td>' + '<td>' + escapeHtml(it.status||'-') + '</td>' + '</tr>';
      });
      const html = '<!doctype html><html><head><meta charset=\"utf-8\"><title>Cetak Data Karyawan</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #333;padding:6px;text-align:center}th{background:#4CAF50;color:#fff}</style></head><body><h2>Data Karyawan</h2><table><thead><tr><th>Nama</th><th>NIK</th><th>Alamat</th><th>Telepon</th><th>Pendidikan</th><th>Jabatan</th><th>Status</th></tr></thead><tbody>' + rows + '</tbody></table></body></html>';
      const url = 'data:text/html;charset=utf-8,' + encodeURIComponent(html);
      const w = window.open(url, '_blank');
      if(w) w.onload = function(){ try{ w.print(); }catch(e){} };
      else alert('Pop-up diblokir. Izinkan pop-up untuk mencetak.');
    }

    function exportToExcel(){
      const data = (allData||[]).map(it => ({ Nama: it.nama, NIK: it.nik, Alamat: it.alamat, Telepon: it.telepon, Pendidikan: it.pendidikan, Jabatan: it.jabatan, Status: it.status }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Karyawan');
      XLSX.writeFile(wb, 'Data-Karyawan-' + new Date().toLocaleDateString('id-ID').replace(/\//g,'-') + '.xlsx');
    }

    // =================== SAMPLE DATA ===================
    function seedSampleData(){
      const demo = [
        { nama:'Agus Santoso', nik:'3201012001010001', alamat:'Bandar Lampung', telepon:'081234567890', pendidikan:'Sarjana', jabatan:'Teller', status:'Aktif', fileName:'', fileData:'', fotoUrl:'' },
        { nama:'Siti Aminah', nik:'3201012001020002', alamat:'Metro', telepon:'081298765432', pendidikan:'SMA/SMK/MA', jabatan:'Customer Service', status:'Non Aktif', fileName:'', fileData:'', fotoUrl:'' },
        { nama:'Budi Hartono', nik:'3201012001030003', alamat:'Lampung Tengah', telepon:'081212121212', pendidikan:'Magister', jabatan:'Manajer', status:'Resign', fileName:'', fileData:'', fotoUrl:'' }
      ];
      demo.forEach(d => {
        const found = allData.findIndex(x => x.nik === d.nik);
        if(found >= 0) allData[found] = d; else allData.push(d);
      });
      saveLocalData(); renderAll();
      backupKeSupabase(allData);
    }

    // =================== GOOGLE DRIVE BACKUP ===================
    function gapiLoadAndAuth(callback) {
      if(!window.gapi){ alert('Google API library belum tersedia. Pastikan koneksi internet dan domain Anda diijinkan di OAuth client.'); return; }
      gapi.load("client:auth2", () => {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
          scope: SCOPES,
        }).then(() => {
          const GoogleAuth = gapi.auth2.getAuthInstance();
          if (!GoogleAuth.isSignedIn.get()) {
            GoogleAuth.signIn().then(callback).catch(e => { console.error('GAuth signIn error', e); alert('Gagal sign-in Google'); });
          } else {
            callback();
          }
        }).catch(err => { console.error('gapi init error', err); alert('Inisialisasi Google API gagal. Periksa CLIENT_ID/API_KEY.'); });
      });
    }

    function backupKeGoogleDrive() {
      if(!CLIENT_ID || CLIENT_ID.startsWith('YOUR_') || !API_KEY || API_KEY.startsWith('YOUR_')) {
        alert('Google Drive belum dikonfigurasi. Ganti CLIENT_ID dan API_KEY di konfigurasi.');
        return;
      }
      gapiLoadAndAuth(async () => {
        try{
          const content = JSON.stringify(allData, null, 2);
          const file = new Blob([content], { type: "application/json" });
          const metadata = {
            name: "Backup-Karyawan-" + new Date().toISOString() + ".json",
            mimeType: "application/json",
          };

          const accessToken = gapi.auth.getToken().access_token;
          const form = new FormData();
          form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
          form.append("file", file);

          const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
            method: "POST",
            headers: new Headers({ "Authorization": "Bearer " + accessToken }),
            body: form,
          });
          const val = await res.json();
          if(val && val.id) alert("Backup berhasil ke Google Drive. File ID: " + val.id);
          else { console.error('Drive upload result', val); alert('Backup Drive gagal - periksa console'); }
        }catch(err){ console.error('Backup Drive gagal', err); alert('Backup Drive gagal'); }
      });
    }

    // =================== INIT BINDINGS ===================
    document.addEventListener('DOMContentLoaded', function(){
      // UI bindings
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('saveBtn').addEventListener('click', simpanKaryawan);
      document.getElementById('clearBtn').addEventListener('click', clearForm);
      document.getElementById('searchInput').addEventListener('input', searchKaryawan);
      document.getElementById('printBtn').addEventListener('click', cetakData);
      document.getElementById('exportBtn').addEventListener('click', exportToExcel);
      document.getElementById('sampleBtn').addEventListener('click', seedSampleData);
      document.getElementById('backupDriveBtn').addEventListener('click', backupKeGoogleDrive);

      // load local
      try{ allData = JSON.parse(localStorage.getItem('karyawanData'))||[]; }catch(e){ allData = []; }
      renderAll();
    });
  </script>
</body>
</html>
