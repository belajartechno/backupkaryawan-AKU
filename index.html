<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Karyawan</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body{font-family:Roboto,Arial,sans-serif;background:#f4f4f4;margin:0;padding:18px;color:#222}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.06);margin-bottom:18px}
    h3,h4{margin:0 0 10px 0}
    input,select,button{font-size:14px}
    input,select{width:100%;padding:8px;margin:6px 0;border:1px solid #ddd;border-radius:6px}
    button{padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
    .btn-primary{background:#4CAF50;color:#fff}
    .btn-secondary{background:#2196F3;color:#fff}
    .btn-danger{background:#f44336;color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e6e6e6;padding:6px;text-align:center}
    th{background:#4CAF50;color:#fff}
    img.profile-thumb{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid #ddd}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <div class="card">
    <h3>Form Karyawan</h3>
    <input type="hidden" id="editId" value="">
    <div class="grid-2">
      <input id="nama" type="text" placeholder="Nama Lengkap">
      <input id="nik" type="text" placeholder="NIK (unik)">
      <input id="alamat" type="text" placeholder="Alamat">
      <input id="telepon" type="text" placeholder="Telepon">
    </div>
    <div class="grid-2">
      <input id="mulai" type="date">
      <input id="pendidikan" type="text" placeholder="Pendidikan">
      <input id="jabatan" type="text" placeholder="Jabatan">
      <input id="status" type="text" placeholder="Status">
    </div>
    <div class="grid-2">
      <input id="fileUpload" type="file">
      <input id="fotoUpload" type="file" accept="image/*">
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
      <button id="clearBtn" class="btn-secondary">Clear</button>
      <button id="saveBtn" class="btn-primary">Simpan</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px;">
      <button id="exportBtn" class="btn-primary">Export Excel</button>
      <button id="backupDriveBtn" class="btn-secondary">Backup ke Google Drive</button>
      <button id="restoreDriveBtn" class="btn-secondary">Restore dari Google Drive</button>
    </div>
    <table id="karyawanTable">
      <thead>
        <tr>
          <th>Foto</th>
          <th>Nama</th>
          <th>NIK</th>
          <th>Alamat</th>
          <th>Telepon</th>
          <th>Pendidikan</th>
          <th>Jabatan</th>
          <th>Status</th>
          <th>File</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // === Data lokal
    let allData = JSON.parse(localStorage.getItem("karyawanData")||"[]");

    // === CRUD ===
    function renderAll(){
      const tbody = document.querySelector("#karyawanTable tbody");
      tbody.innerHTML = "";
      allData.forEach((it,idx)=>{
        const tr = document.createElement("tr");
        // foto
        const fotoTd = document.createElement("td");
        if(it.fotoUrl){
          const img = document.createElement("img");
          img.src = it.fotoUrl;
          img.className = "profile-thumb";
          fotoTd.appendChild(img);
        } else fotoTd.textContent = "-";
        tr.appendChild(fotoTd);
        // kolom lain
        tr.innerHTML += `
          <td>${it.nama}</td>
          <td>${it.nik}</td>
          <td>${it.alamat||""}</td>
          <td>${it.telepon||""}</td>
          <td>${it.pendidikan||""}</td>
          <td>${it.jabatan||""}</td>
          <td>${it.status||""}</td>
          <td>${it.fileName||"-"}</td>
          <td>
            <button onclick="editData(${idx})">Edit</button>
            <button onclick="deleteData(${idx})">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function clearForm(){
      document.querySelectorAll("#editId,#nama,#nik,#alamat,#telepon,#mulai,#pendidikan,#jabatan,#status").forEach(el=>el.value="");
      document.querySelector("#fileUpload").value="";
      document.querySelector("#fotoUpload").value="";
    }

    function saveData(){
      const id = document.getElementById("editId").value;
      const data = {
        nama: document.getElementById("nama").value,
        nik: document.getElementById("nik").value,
        alamat: document.getElementById("alamat").value,
        telepon: document.getElementById("telepon").value,
        mulai: document.getElementById("mulai").value,
        pendidikan: document.getElementById("pendidikan").value,
        jabatan: document.getElementById("jabatan").value,
        status: document.getElementById("status").value,
        fileName: document.getElementById("fileUpload").files[0]?.name || "",
        fotoUrl: ""
      };

      // foto upload â†’ hanya untuk preview lokal, backup akan ambil dari Supabase URL kalau ada
      const fotoFile = document.getElementById("fotoUpload").files[0];
      if(fotoFile){
        data.fotoUrl = URL.createObjectURL(fotoFile);
      }

      if(id){
        allData[id] = data;
      } else {
        allData.push(data);
      }
      localStorage.setItem("karyawanData", JSON.stringify(allData));
      clearForm();
      renderAll();
    }

    function editData(idx){
      const d = allData[idx];
      document.getElementById("editId").value = idx;
      document.getElementById("nama").value = d.nama;
      document.getElementById("nik").value = d.nik;
      document.getElementById("alamat").value = d.alamat;
      document.getElementById("telepon").value = d.telepon;
      document.getElementById("mulai").value = d.mulai;
      document.getElementById("pendidikan").value = d.pendidikan;
      document.getElementById("jabatan").value = d.jabatan;
      document.getElementById("status").value = d.status;
    }

    function deleteData(idx){
      if(confirm("Hapus data ini?")){
        allData.splice(idx,1);
        localStorage.setItem("karyawanData", JSON.stringify(allData));
        renderAll();
      }
    }

    document.getElementById("saveBtn").onclick = saveData;
    document.getElementById("clearBtn").onclick = clearForm;

    // === Export Excel ===
    document.getElementById("exportBtn").onclick = ()=>{
      const ws = XLSX.utils.json_to_sheet(allData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Karyawan");
      XLSX.writeFile(wb, "Data-Karyawan.xlsx");
    };

    // === Backup ke Google Drive (via Apps Script) ===
    async function backupKeGoogleDrive() {
      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbxBddB4Qb9MUKY_qF3M10DXK0o96Won_-0tD8FvbZGt_xZ4b1PyfzVPZlaoQU49BQYenQ/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(allData)
        });
        const result = await response.json();
        if (result.status === "success") {
          alert("Backup sukses! File tersimpan di Drive: " + result.fileUrl);
        } else {
          alert("Backup gagal: " + result.message);
        }
      } catch (err) {
        console.error("Backup error", err);
        alert("Backup gagal (lihat console)");
      }
    }

    // === Restore dari Google Drive (via Apps Script) ===
    async function restoreDariGoogleDrive() {
      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbxBddB4Qb9MUKY_qF3M10DXK0o96Won_-0tD8FvbZGt_xZ4b1PyfzVPZlaoQU49BQYenQ/exec", { method: "GET" });
        const result = await response.json();
        if (result.status === "success" && result.data) {
          allData = result.data;
          localStorage.setItem("karyawanData", JSON.stringify(allData));
          renderAll();
          alert("Restore sukses dari backup: " + result.fileUrl);
        } else {
          alert("Restore gagal: " + result.message);
        }
      } catch (err) {
        console.error("Restore error", err);
        alert("Restore gagal (lihat console)");
      }
    }

    document.getElementById("backupDriveBtn").onclick = backupKeGoogleDrive;
    document.getElementById("restoreDriveBtn").onclick = restoreDariGoogleDrive;

    // init
    renderAll();
  </script>
</body>
</html>
